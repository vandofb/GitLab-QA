services:
 - docker:1.12-dind

stages:
  - build
  - check
  - test

variables:
  TEST_IMAGE_NAME: registry.gitlab.com/gitlab-org/gitlab-qa
  TEST_IMAGE: $TEST_IMAGE_NAME:latest
  DOCKER_DRIVER: overlay
  DOCKER_HOST: tcp://docker:2375

# Workaround for gitlab-org/gitlab-ce#22598
#
build:stub:
  stage: build
  script: echo 'Starting pipeline ...'

build:image:
  image: docker:1.12
  stage: build
  script:
    - docker build -t $TEST_IMAGE .
    - test -n "$CI_BUILD_TOKEN" || exit 0
    - docker login --username gitlab-ci-token --password $CI_BUILD_TOKEN registry.gitlab.com
    - docker push $TEST_IMAGE
    - docker logout registry.gitlab.com
  except:
    - triggers
    - master
  tags:
    - docker
  when: manual

check:rubocop:
  stage: check
  image: ruby:2.3
  script:
    - gem install rubocop
    - rubocop
  except:
    - triggers
  tags:
    - docker

check:rspec:
  stage: check
  image: $TEST_IMAGE
  script: bin/test Internal::Unit
  except:
    - triggers
  tags:
    - docker

.test: &test
  stage: test
  image: $TEST_IMAGE
  tags:
    - docker
  artifacts:
    when: on_failure
    expire_in: 30d
    paths:
      - tmp/*.png

ce:instance:
  script: bin/test Instance::CE
  <<: *test

ee:instance:
  script: bin/test Instance::EE
  <<: *test

ce:image:
  script: bin/test Omnibus::Image CE
  <<: *test

ee:image:
  script: bin/test Omnibus::Image EE
  <<: *test

ce:upgrade:
  script: bin/test Omnibus::Upgrade
  <<: *test
