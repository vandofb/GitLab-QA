#!/bin/sh

case "$1" in
    build)
        docker pull -a $CI_REGISTRY_IMAGE
        docker build --cache-from $CI_REGISTRY_IMAGE -t $CI_REGISTRY_IMAGE:ce-nightly .
        docker build --cache-from $CI_REGISTRY_IMAGE -t $CI_REGISTRY_IMAGE:ee-nightly .
        ;;
    publish)
        test -n "$CI_BUILD_TOKEN" || exit 1
        docker login --username gitlab-ci-token --password $CI_BUILD_TOKEN registry.gitlab.com
        docker push $CI_REGISTRY_IMAGE:ce-nightly
        docker push $CI_REGISTRY_IMAGE:ee-nightly
        docker logout registry.gitlab.com
        ;;
    *)
        echo "Usage: $0 [build|publish]"
        exit 1
        ;;
esac
